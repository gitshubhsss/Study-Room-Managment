<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Student</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>
    <form id="studentForm" action="/newstudent" method="post">
        <input type="text" name="student[name]" placeholder="Enter the student name" required>
        <br><br>
        <input type="email" name="student[email]" placeholder="Enter the email" required>
        <br><br>
        <input type="number" name="student[mobile]" placeholder="Enter the mobile number" required>
        <br><br>
        <input type="date" name="student[startDate]" placeholder="Enter the admission date" required>
        <br><br>
        <input type="date" name="student[endDate]" placeholder="Enter the end date" required>
        <br><br>
        <input type="text" name="student[preparation]" placeholder="Enter the occupation" required>
        <br><br>
        <input type="number" name="student[seat_no]" value="<%= seat %>" readonly>
        <br><br>
        <!-- Hidden fields for payment verification -->
        <input type="hidden" id="razorpay_payment_id" name="razorpay_payment_id">
        <input type="hidden" id="razorpay_order_id" name="razorpay_order_id">
        <input type="hidden" id="razorpay_signature" name="razorpay_signature">
        <button type="button" id="payButton">Proceed to Payment</button>
    </form>

    <script>
        document.getElementById('payButton').addEventListener('click', function (e) {
            e.preventDefault();

            // Make an API call to your backend to create a Razorpay order
            fetch('/create-order', { method: 'POST' })
                .then(response => response.json())
                .then(order => {
                    const options = {
                        key: 'rzp_test_cR8X4jkGEnx1zo', // Replace with your Razorpay key ID
                        amount: order.amount,
                        currency: order.currency,
                        name: 'Student Admission',
                        description: 'Payment for admission',
                        order_id: order.id, // Razorpay order ID from your backend
                        handler: function (response) {
                            // Populate the hidden fields with Razorpay response
                            document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
                            document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
                            document.getElementById('razorpay_signature').value = response.razorpay_signature;

                            // Submit the form
                            document.getElementById('studentForm').submit();
                        },
                        prefill: {
                            name: document.querySelector('input[name="student[name]"]').value,
                            email: document.querySelector('input[name="student[email]"]').value,
                            contact: document.querySelector('input[name="student[mobile]"]').value,
                        },
                        theme: {
                            color: '#3399cc'
                        }
                    };

                    const rzp = new Razorpay(options);
                    rzp.open();
                })
                .catch(error => {
                    console.log('Error creating Razorpay order:', error);
                    alert('Failed to initiate payment. Please try again.');
                });
        });
    </script>
</body>

</html>
